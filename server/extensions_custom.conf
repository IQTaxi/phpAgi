[from-internal]
exten => 32,1,Set(UNIQ=${UNIQUEID})
 same => n,Set(FILEBASE=/tmp/${CALLERID(num)}/${UNIQ})
 same => n,System(mkdir -p ${FILEBASE})
 same => n,Wait(1)
 same => n,Playback(custom/welcome-v2)

; --- NAME (3 retries) ---
 same => n,Set(NAME_TRY=1)
 same => n(name_retry),GotoIf($[${NAME_TRY} > 3]?fail)
 same => n,Playback(custom/give-mame-v2)
 same => n,Record(${FILEBASE}/name.wav16,2,10)
 same => n,System(python3.9 /usr/local/bin/send_to_google_stt.py ${FILEBASE}/name.wav16 > ${FILEBASE}/name.txt)
 same => n,Wait(1)
 same => n,Set(NAME_SIZE=${STAT(s,${FILEBASE}/name.txt)})
 same => n,GotoIf($[${NAME_SIZE} < 2]?name_retry_inc)
 same => n,Goto(pickup)

 same => n(name_retry_inc),Set(NAME_TRY=$[${NAME_TRY} + 1])
 same => n,Goto(name_retry)

; --- PICKUP (3 retries) ---
 same => n(pickup),Set(PICKUP_TRY=1)
 same => n(pickup_retry),GotoIf($[${PICKUP_TRY} > 3]?fail)
 same => n,Playback(custom/give-pickup-address-v2)
 same => n,Record(${FILEBASE}/pickup.wav16,2,10)
 same => n,System(python3.9 /usr/local/bin/send_to_google_stt.py ${FILEBASE}/pickup.wav16 > ${FILEBASE}/pickup.txt)
 same => n,System(python3.9 /usr/local/bin/fetch_latlng_google.py ${FILEBASE}/pickup.txt > ${FILEBASE}/location-pickup.txt)
 same => n,Wait(1)
 same => n,Set(PICKUP_TXT_SIZE=${STAT(s,${FILEBASE}/pickup.txt)})
 same => n,GotoIf($[${PICKUP_TXT_SIZE} < 2]?pickup_retry_inc)
 same => n,Set(PICKUP_LOC_SIZE=${STAT(s,${FILEBASE}/location-pickup.txt)})
 same => n,GotoIf($[${PICKUP_LOC_SIZE} < 2]?pickup_retry_inc)
 same => n,Goto(dest)

 same => n(pickup_retry_inc),Set(PICKUP_TRY=$[${PICKUP_TRY} + 1])
 same => n,Goto(pickup_retry)

; --- DESTINATION (3 retries) ---
 same => n(dest),Set(DEST_TRY=1)
 same => n(dest_retry),GotoIf($[${DEST_TRY} > 3]?fail)
 same => n,Playback(custom/give-dest-address-v2)
 same => n,Record(${FILEBASE}/dest.wav16,2,10)
 same => n,System(python3.9 /usr/local/bin/send_to_google_stt.py ${FILEBASE}/dest.wav16 > ${FILEBASE}/dest.txt)
 same => n,System(python3.9 /usr/local/bin/fetch_latlng_google.py ${FILEBASE}/dest.txt > ${FILEBASE}/location-dest.txt)
 same => n,Wait(1)
 same => n,Set(DEST_TXT_SIZE=${STAT(s,${FILEBASE}/dest.txt)})
 same => n,GotoIf($[${DEST_TXT_SIZE} < 2]?dest_retry_inc)
 same => n,Set(DEST_LOC_SIZE=${STAT(s,${FILEBASE}/location-dest.txt)})
 same => n,GotoIf($[${DEST_LOC_SIZE} < 2]?dest_retry_inc)
 same => n,Goto(confirm)

 same => n(dest_retry_inc),Set(DEST_TRY=$[${DEST_TRY} + 1])
 same => n,Goto(dest_retry)

; --- CONFIRM with 3 DTMF attempts ---
 same => n(confirm),Set(CONFIRM_TRY=1)
 same => n(confirm_loop),GotoIf($[${CONFIRM_TRY} > 3]?fail)
 same => n,System(wget -q -O ${FILEBASE}/confirm.mp3 "http://188.245.212.246:221/tts?text=Παρακαλώ επιβεβαιώστε. Όνομα: $(cat ${FILEBASE}/name.txt). Παραλαβή: $(cat ${FILEBASE}/pickup.txt). Προορισμός: $(cat ${FILEBASE}/dest.txt)&lang=el")
 same => n,MP3Player(${FILEBASE}/confirm.mp3)

 same => n,System(wget -q -O ${FILEBASE}/options.mp3 "http://188.245.212.246:221/tts?text=Πατήστε 0 για επιβεβαίωση, 1 για αλλαγή ονόματος, 2 για αλλαγή παραλαβής, 3 για αλλαγή προορισμού&lang=el")
 same => n,Read(DTMF_OPTION,${FILEBASE}/options,1,,,5)
 same => n,GotoIf($["${DTMF_OPTION}" = "0"]?do_register)
 same => n,GotoIf($["${DTMF_OPTION}" = "1"]?name_retry)
 same => n,GotoIf($["${DTMF_OPTION}" = "2"]?pickup_retry)
 same => n,GotoIf($["${DTMF_OPTION}" = "3"]?dest_retry)
 same => n,Playback(custom/invalid-v2)
 same => n,Set(CONFIRM_TRY=$[${CONFIRM_TRY} + 1])
 same => n,Goto(confirm_loop)

; --- REGISTER ---
 same => n(do_register),System(python3.9 /usr/local/bin/register_call.py ${CALLERID(num)} ${FILEBASE}/name.txt ${FILEBASE}/pickup.txt ${FILEBASE}/location-pickup.txt ${FILEBASE}/dest.txt ${FILEBASE}/location-dest.txt > ${FILEBASE}/register.txt)
 same => n,System(wget -q -O ${FILEBASE}/register.mp3 "http://188.245.212.246:221/tts?text=$(cat ${FILEBASE}/register.txt)&lang=el")
 same => n,MP3Player(${FILEBASE}/register.mp3)
 same => n,Hangup()

; --- FAIL PATH ---
 same => n(fail),Playback(custom/invalid-v3)
 same => n,Dial(SIP/20,20)
 same => n,Hangup()